Аффинные преобразования в пространстве (А.В.Боресков,Е.В.Шикин "Компьютерная
графика. Динамика, реалистические изображения", М:"ДИАЛОГ-МИФИ",1995, стр.82)

Представим координаты точки в пр-ве

    (x y z 1)

* 1 - компонента нормализации

или, более общо, в виде

    (hx hy hz), h != 0

    Предложенный переход к новому способу задания точек дает возможность вос-
пользоваться матричной записью и в более сложных, трехмерных задачах.
    Любое аффинное преобразование в 3-хмерном пр-ве м/б представлено в виде
суперпозиций вращений, растяжений, отражений и переносов. Поэтому вполне
уместно сначала подробно описать матрицы именно этих преобразований (ясно, что
в данном случае порядок матриц должен быть равен четырем)

  А. Матрицы вращения в пространстве (Rotation):

    Матрица вращения вокруг оси абсцисс на угол phi

            │ 1    0         0     0 │
            │                        │
            │ 0 cos(phi)  sin(phi) 0 │
    [Rx] =  │                        │
            │ 0 -sin(phi) cos(phi) 0 │
            │                        │
            │ 0    0         0     1 │

    Матрица вращения вокруг оси ординат на угол psi

            │ cos(psi) 0 -sin(psi) 0 │
            │                        │      (ВНИМАНИЕ!: далее в коде приведен-
            │ 0    1         0     0 │      ном в книге, -sin(psi) и sin(psi)
    [Ry] =  │                        │      поменяны местами. Протестируйте
            │ sin(psi) 0  cos(psi) 0 │      код или найдите где-нибудь, как
            │                        │      будет правильно! И сообщите мне,
            │ 0    0         0     1 │      плиз!)

    Матрица вращения вокруг оси аппликат на угол hi

            │ cos(hi)  sin(hi)  0  0 │
            │                        │
            │ -sin(hi) cos(hi)  0  0 │
    [Rz] =  │                        │
            │    0       0      1  0 │
            │                        │
            │    0       0      0  1 │

  Б. Матрица растяжения (сжатия) (Dilatation):

           │ alpha  0     0   0 │
           │                    │
           │   0   beta   0   0 │
    [D] =  │                    │
           │   0    0   gamma 0 │
           │                    │
           │   0    0     0   1 │

    где:
      alpha > 0 - коэфф растяжения (сжатия) вдоль оси абсцисс
      beta  > 0 - коэфф растяжения (сжатия) вдоль оси ординат
      gamma > 0 - коэфф растяжения (сжатия) вдоль оси аппликат

  В. Матрицы отражения (Mirror):

    Матрица отражения относительно плоскости xy:

            │ 1  0   0  0 │
            │             │
            │ 0  1   0  0 │
    [Mz] =  │             │
            │ 0  0  -1  0 │
            │             │
            │ 0  0   0  1 │

    Матрица отражения относительно плоскости yz:

            │ -1  0  0  0 │
            │             │
            │  0  1  0  0 │
    [Mx] =  │             │
            │  0  0  1  0 │
            │             │
            │  0  0  0  1 │

    Матрица отражения относительно плоскости xz:

            │ 1   0  0  0 │
            │             │
            │ 0  -1  0  0 │
    [My] =  │             │
            │ 0   0  1  0 │
            │             │
            │ 0   0  0  1 │


  Г. Матрица переноса (Translation): (lambda,mu,nu) - вектор переноса

           │    1    0   0   0 │
           │                   │
           │    0    1   0   0 │
    [T] =  │                   │
           │    0    0   1   0 │
           │                   │
           │ lambda  mu  nu  1 │

Замечание: как и в двумерном случае, все выписанные матрицы невырожденны.

    Приведем важный пример построения матрицы сложного преобразования по его
геометрическому описанию.

Пример 1: Построить матрицу вращения на угол phi вокруг прямой L, проходящей
через точку A(a, b, c) и имеющую направляющий вектор (l, m, n). Можно считать,
что направляющий вектор прямой является единичным: l^2 + m^2 + n^2 = 1

z |      / L
  |     /
  |  / / 
  |  (/__) <- направление вращения (против часовой стрелки)
  |  /
  | /
  |/
  |
  |________________
  /                y
 /
/x

Решение задачи разбивается на несколько шагов.
Опишем последовательно каждый из них.

Шаг 1. Перенос на вектор -A(-a, -b, -c) при помощи матрицы

           │    1    0   0   0 │
           │                   │
           │    0    1   0   0 │
    [T] =  │                   │
           │    0    0   1   0 │
           │                   │
           │   -a   -b   -c  1 │

В результате этого переноса мы добиваемся того, чтобы прямая L проходила через
начало координат.

Шаг 2. Совмещение оси аппликат с прямой L двумя поворотами вокруг оси абсцисс
и оси ординат.
  1й поворот - вокруг оси абсцисс на угол psi (подлежащий определению). Чтобы
найти этот угол, рассмотрим ортогональную проекцию L' исходной прямой L на
плоскость X = 0.
  Направляющий вектор прямой L' равен (0, m, n). Отсюда сразу же вытекает, что

  cos(psi) = n / d
  sin(psi) = m / d
           ___________
  где d = √ m^2 + n^2

  Соответсвующая матрица вращения имеет вид:

            │ 1    0      0     0 │
            │                     │
            │ 0  n / d  m / d   0 │
    [Rx] =  │                     │
            │ 0 -m / d  n / d   0 │
            │                     │
            │ 0    0      0     1 │

  Под действием преобразования, описываемого этой матрицей, координаты вектора
(l, m, n) изменятся. Подсчитав их, получим (l, m, n)[Rx] = (l, 0, d, 1)

  2й поворот - вокруг оси ординат на угол theta, определяемый соотношениями

  cos(theta) = l
  sin(theta) = -d

  Соответствующая матрица:

            │  l  0  d  0 │
            │             │      (ВНИМАНИЕ!: неизвестна правиль-
            │  0  1  0  0 │      ность этой матрицы)
    [Ry] =  │             │
            │ -d  0  l  0 │
            │             │
            │  0  0  0  1 │

Шаг 3. Вращение вокруг прямой L на заданный угол phi

  Так как теперь прямая L совпадает с осью аппликат, то соответствующая матри-
ца имеет вид:

            │ cos(phi)  sin(phi)  0  0 │
            │                          │
            │ -sin(phi) cos(phi)  0  0 │
    [Rz] =  │                          │
            │     0        0      1  0 │
            │                          │
            │     0        0      0  1 │

Шаг 4. Поворот вокруг оси ординат на угол -theta.
Шаг 5. Поворот вокруг оси абсцисс на угол -psi.

  Замечание: Вращение в пространстве НЕКОММУТАТИВНО. Поэтому порядок, в кото-
ром проводятся вращения, является весьма существенным.

Шаг 6. Перенос на вектор A(a, b, c).

Перемножив найденные матрицы в порядке их построения, получим следующую
матрицу:

  [T][Rx][Ry][Rz][Ry]^(-1)[Rx]^(-1)[T]^(-1)

  Выпишем окончательный результат, считая для простоты, что ось вращения L
проходит через начальную точку:

l^2+cos(phi)*(1-l^2) l*(1-cos(phi))*m+n*sin(phi) l*(1-cos(phi)*n-m*sin(phi) 0
l*(1-cos(phi)*m-n*sin(phi) m^2+cos(phi)*(1-m^2) m*(1-cos(phi))*n+l*sin(phi) 0
l*(1-cos(phi))*n+m*sin(phi) m*(1-cos(phi)*n-l*sin(phi) n^2+cos(phi)*(1-n^2) 0
        0                          0                        0               1

Рассматривая другие примеры подобного рода, мы будем получать в результате не-
вырожденные матрицы вида

        │ a1 a2 a3 0 │
        │            │
        │ b1 b2 b3 0 │
  [A] = │            │
        │ c1 c2 c3 0 │
        │            │
        │ l  m  n  1 │

  При помощи таких матриц можно преобразовывать любые плоские и пространствен-
ные фигуры.
